name: Reusable Examples Tests

on:
  workflow_call:
    inputs:
      examples:
        required: false
        type: string
        default: '["multi-metric-qa", "graphrag-vs-rag", "multimedia", "deduplication", "eval-framework", "descriptive-graph-metrics"]'
        description: "List of examples to test"
    secrets:
      inherit: true

jobs:
  run-examples-tests:
    name: ${{ matrix.example }} Tests
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        example: ${{ fromJSON(inputs.examples) }}
      fail-fast: false
    
    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.x'
          
      - name: Install Poetry
        uses: snok/install-poetry@v1.4.1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Install Dependencies
        run: poetry install --no-interaction --all-extras

      - name: Run Multi-Metric QA Evaluation
        if: ${{ matrix.example == 'multi-metric-qa' }}
        env:
          ENV: 'dev'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: poetry run python ./examples/python/multimetric_qa_eval_run.py
        
      - name: Run GraphRAG vs RAG Test
        if: ${{ matrix.example == 'graphrag-vs-rag' }}
        env:
          ENV: 'dev'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GRAPHISTRY_USERNAME: ${{ secrets.GRAPHISTRY_USERNAME }}
          GRAPHISTRY_PASSWORD: ${{ secrets.GRAPHISTRY_PASSWORD }}
        run: poetry run python ./examples/python/graphrag_vs_rag_notebook.py
        
      - name: Run Multimedia Example
        if: ${{ matrix.example == 'multimedia' }}
        env:
          ENV: 'dev'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: poetry run python ./examples/python/multimedia_example.py
        
      - name: Run Deduplication Tests
        if: ${{ matrix.example == 'deduplication' }}
        env:
          ENV: 'dev'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: poetry run python ./examples/python/deduplication.py
        
      - name: Run Eval Framework Tests
        if: ${{ matrix.example == 'eval-framework' }}
        env:
          ENV: 'dev'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: poetry run python ./examples/python/eval_framework.py
        
      - name: Run Descriptive Graph Metrics Tests
        if: ${{ matrix.example == 'descriptive-graph-metrics' }}
        env:
          ENV: 'dev'
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GRAPHISTRY_USERNAME: ${{ secrets.GRAPHISTRY_USERNAME }}
          GRAPHISTRY_PASSWORD: ${{ secrets.GRAPHISTRY_PASSWORD }}
        run: poetry run python ./examples/python/descriptive_graph_metrics.py 